# 09. 통합 요구사항 (외부 서비스 연동)

## 통합 우선순위 요약

| 통합 | 우선순위 | Phase | 용도 |
|------|---------|-------|------|
| Kakao Login | **P0** | Phase 1 | 주요 인증 |
| KakaoTalk Share | **P0** | Phase 1 | 말씀노트/공지 공유 |
| Kakao 알림톡 | **P0** | Phase 1 | 공식 알림 |
| FCM/APNs | **P0** | Phase 1 | 푸시 알림 |
| 한글 성경 API | **P1** | Phase 2 | 구절 자동 링크 |
| Google Cloud STT | **P0** | Phase 2 | 음성→텍스트 변환 |
| Google Cloud TTS | **P1** | Phase 2 | 다국어 말씀 음성 재생 |
| 토스페이먼츠 | **P0** | Phase 2 | 구독 결제 |
| Google/Naver Calendar | **P2** | Phase 3 | 일정 동기화 |
| SMS | **P2** | Phase 3 | 문자 알림 |
| KakaoPay | **P2** | Phase 4 | 온라인 헌금 |

---

## Phase 1 통합 상세

### 1. Kakao Login (P0)

**용도**: 주요 소셜 로그인

**구현 방식**:
- Supabase Auth의 Kakao OAuth Provider 활용
- Supabase 설정에서 Kakao 앱 키 등록
- 로그인 플로우: 앱 → Supabase Auth → Kakao OAuth → 토큰 반환

**필요 정보**:
- Kakao Developers 앱 등록
- REST API 키, JavaScript 키
- Redirect URI 설정

**대체 인증**:
- 이메일 + 비밀번호 (Supabase Auth 기본)
- 전화번호 OTP (고령 교인 대응)

---

### 2. KakaoTalk Share (P0)

**용도**: 말씀노트, 공지사항, 설교 카카오톡 공유

**구현 방식**:
- Kakao SDK JavaScript / React Native SDK
- 커스텀 템플릿 메시지 (말씀노트 카드형)
- 링크 공유 (딥링크 → 앱/웹 연결)

**공유 콘텐츠 유형**:

| 유형 | 카카오 메시지 템플릿 | 내용 |
|------|-------------------|------|
| 말씀노트 | 카드형 | 제목, 구절, 핵심 내용, 링크 |
| 공지사항 | 리스트형 | 제목, 일시, 상세 링크 |
| 설교 | 카드형 | 설교 제목, 설교자, 듣기 링크 |
| 새가족 등록 | 카드형 | 교회명, QR코드, 등록 링크 |

---

### 3. Kakao 알림톡 (P0)

**용도**: 공식 알림 발송 (가입승인, 공지, 행사 등)

**구현 방식**:
- Kakao 비즈니스 채널 등록
- 알림톡 API 연동 (Supabase Edge Function에서 호출)
- 템플릿 메시지 사전 승인 필요

**알림톡 시나리오**:

| 시나리오 | 수신자 | 내용 |
|---------|--------|------|
| 가입 승인 요청 | 교회 관리자 | "새로운 가입 요청이 있습니다" |
| 가입 승인 완료 | 신규 교인 | "가입이 승인되었습니다" |
| 교회 공지 | 전체 교인 | "새로운 공지가 등록되었습니다" |
| 행사 알림 | 대상 교인 | "행사 안내: [행사명]" |
| STT 변환 완료 | 노트 작성자 | "말씀노트 변환이 완료되었습니다" |
| 결재 요청 | 결재자 | "새로운 결재 문서가 있습니다" |
| 교역자 피드백 | 성도 | "교역자님의 피드백이 있습니다" |

**비용**: 건당 약 8-15원

---

### 4. FCM / APNs (P0)

**용도**: 모바일 푸시 알림

**구현 방식**:
- Firebase Cloud Messaging (FCM) - Android + iOS 통합
- React Native: expo-notifications
- PWA: Web Push API + Service Worker
- Supabase Edge Function에서 FCM API 호출

**푸시 알림 유형**:
- 즉시 알림: 가입 승인, 교역자 피드백, 결재 요청
- 예약 알림: 행사 리마인더, 통독 알림, 암송 알림
- 조건 알림: STT 변환 완료

**비용**: 무료 (무제한)

---

## Phase 2 통합 상세

### 5. Google Cloud Speech-to-Text (P0)

**용도**: 한국어 설교 음성→텍스트 자동 변환

**구현 방식**:
- Supabase Edge Function에서 Google Cloud STT API 호출
- 오디오 파일 (WebM/MP3) → STT API → 텍스트 반환
- 후처리: 성경 용어 교정, 구절 감지

**API 설정**:
- Google Cloud 프로젝트 생성
- Speech-to-Text API 활성화
- 서비스 계정 키 발급
- 언어: ko-KR (한국어)
- 모델: latest_long (긴 오디오용)
- 기능: 자동 구두점, 단어 타임스탬프

**비용**:
- 무료: 월 60분
- 초기 크레딧: $300 (새 계정)
- 초과: $0.016/분 (~22원)

**폴백 전략**:
1. Google Cloud STT 실패 → Whisper API ($0.006/분)
2. Whisper 실패 → CLOVA Speech (~900원/분, 정확도 우선)

---

### 6. Google Cloud Text-to-Speech (P1)

**용도**: 다국어 말씀 암송 음성 재생

**구현 방식**:
- Supabase Edge Function에서 TTS API 호출
- 텍스트 → 오디오 파일 (MP3) → Supabase Storage 캐싱
- 클라이언트에서 오디오 재생

**지원 언어 및 음성**:

| 언어 | 음성 코드 | 품질 |
|------|----------|------|
| 한국어 | ko-KR-Wavenet-A/B | 고품질 |
| 영어 | en-US-Wavenet-D/F | 고품질 |
| 일본어 | ja-JP-Wavenet-B/C | 고품질 |
| 중국어 | cmn-CN-Wavenet-A/B | 고품질 |

**비용**: 무료 월 400만 글자 (Wavenet)

**캐싱 전략**:
- 동일 구절+언어 조합은 한번만 TTS 호출
- 생성된 오디오를 Supabase Storage에 캐싱
- 클라이언트: 자주 듣는 구절 로컬 캐싱 (오프라인 재생)

---

### 7. 한글 성경 API (P1)

**용도**: 성경 구절 자동 링크, 암송/통독 데이터

**후보 API**:
- Bible API (자체 구축 또는 오픈소스)
- 개역개정/새번역 데이터 라이선스 확인 필요
- 다국어 API (NIV, ESV, KJV, 新共同訳, 和合本)

**구현 방식**:
- 성경 데이터를 Supabase DB에 저장 (정적 데이터)
- 구절 패턴 감지 정규식: `(창|출|레|민|신|수|삿|룻|삼상|삼하|...)\s*(\d+)\s*[:장]\s*(\d+)`
- 노트 텍스트에서 구절 감지 → 자동 링크 생성

---

### 8. 토스페이먼츠 (P0, Phase 2)

**용도**: SaaS 구독 결제

**구현 방식**:
- 토스페이먼츠 결제 SDK 연동
- 자동 결제 (빌링키 발급)
- 월간/연간 구독 관리
- 결제 실패 시 재시도 로직

**결제 시나리오**:
- 무료 → 유료 업그레이드 시 카드 등록
- 월간 자동 결제 (매월 가입일)
- 연간 결제 시 20% 할인
- 다운그레이드/취소 시 잔여 기간 환불

---

## Phase 3-4 통합 상세

### 9. Google/Naver Calendar (P2, Phase 3)

- Google Calendar API로 교회 일정 동기화
- Naver Calendar API (한국 사용자 대응)
- 양방향 동기화: 앱 ↔ 외부 캘린더

### 10. SMS (P2, Phase 3)

- 알림톡으로 충분하지 않은 경우 SMS 발송
- SMS 발송 서비스 연동 (NHN, 솔라피 등)
- 대량 발송, 개인 발송 지원

### 11. KakaoPay (P2, Phase 4)

- 카카오페이 온라인 헌금 연동
- 정기헌금 자동이체
- 헌금 영수증 자동 발급
- 재정관리 시스템 자동 반영

---

## 통합 아키텍처 요약

```
[ChurchThrive App (PWA + Native)]
     │
     ├── [Supabase Auth] ←→ [Kakao OAuth]
     │
     ├── [Supabase Edge Functions]
     │      ├── → [Google Cloud STT API]
     │      ├── → [Google Cloud TTS API]
     │      ├── → [Whisper API] (폴백)
     │      ├── → [Kakao 알림톡 API]
     │      ├── → [FCM API]
     │      └── → [토스페이먼츠 API]
     │
     ├── [Kakao JS SDK] → [KakaoTalk 공유]
     │
     └── [Supabase DB] ← [성경 데이터 (정적)]
```
