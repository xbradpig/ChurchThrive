# 06. 기술 아키텍처

## 아키텍처 패턴

- **Cloudflare Pages + Supabase 기반 서버리스 아키텍처**
- 초기 인프라 비용 최소화 (무료 티어 최대 활용)
- PWA + React Native 동시 개발

---

## 전체 아키텍처 다이어그램

```
┌──────────────────────┐     ┌──────────────────────┐
│   Cloudflare Pages   │     │   React Native App   │
│   (Next.js PWA)      │     │   (Expo, iOS/Android) │
│   - 글로벌 CDN       │     │   - 오프라인 녹음     │
│   - 자동 HTTPS       │     │   - 로컬 캐시         │
└──────────┬───────────┘     └──────────┬───────────┘
           │                             │
           └──────────┬──────────────────┘
                      │
           ┌──────────▼──────────┐
           │     Supabase        │
           │  ┌───────────────┐  │
           │  │ Auth          │  │  ← Kakao OAuth + Email
           │  │ (50K MAU 무료)│  │
           │  ├───────────────┤  │
           │  │ PostgreSQL DB │  │  ← RLS 멀티테넌시
           │  │ (500MB 무료)  │  │
           │  ├───────────────┤  │
           │  │ Storage       │  │  ← 오디오, 사진, 문서
           │  │ (1GB 무료)    │  │
           │  ├───────────────┤  │
           │  │ Realtime      │  │  ← 출석, 알림 실시간
           │  ├───────────────┤  │
           │  │ Edge Functions│  │  ← STT 호출, 후처리
           │  └───────────────┘  │
           └──────────┬──────────┘
                      │
        ┌─────────────┼─────────────┐
        ▼             ▼             ▼
  ┌──────────┐ ┌──────────┐ ┌──────────┐
  │ Google   │ │ Whisper  │ │ FCM/APNs │
  │ Cloud    │ │ API      │ │ 푸시알림  │
  │ STT/TTS  │ │          │ │          │
  └──────────┘ └──────────┘ └──────────┘
```

---

## 기술 스택 상세

### 프론트엔드

| 기술 | 용도 | 선택 근거 |
|------|------|-----------|
| **Next.js 14+ (App Router)** | 웹 프론트엔드 | SSR/SSG, PWA, Cloudflare Pages 배포, React Server Components |
| **React Native (Expo)** | 모바일 앱 | iOS/Android 동시 개발, React 코드 공유, OTA 업데이트 |
| **TypeScript** | 언어 | 타입 안전성, 개발 생산성 |
| **Tailwind CSS** | 스타일링 | 빠른 UI 개발, 반응형 |
| **Zustand / Jotai** | 상태관리 | 경량, 간단한 API |

### 백엔드 (BaaS)

| 기술 | 용도 | 선택 근거 |
|------|------|-----------|
| **Supabase** | BaaS 플랫폼 | 무료 PostgreSQL + Auth + Storage + Realtime + Edge Functions |
| **Supabase Edge Functions (Deno)** | 서버리스 함수 | STT 호출, 알림 발송, 후처리 로직 |
| **Supabase PostgreSQL RLS** | 데이터 격리 | church_id 기반 멀티테넌시 |
| **Supabase Auth** | 인증 | Kakao OAuth + 이메일/전화번호 |
| **Supabase Storage** | 파일 저장 | 오디오, 사진, 문서 |
| **Supabase Realtime** | 실시간 | 출석 업데이트, 알림 |

> **별도 백엔드 서버 불필요**: Supabase가 DB, Auth, Storage, Realtime, Edge Functions를 모두 제공하므로 백엔드 개발 인력 절감

### 호스팅/인프라

| 기술 | 용도 | 선택 근거 |
|------|------|-----------|
| **Cloudflare Pages** | 웹 호스팅 | 무료 무제한 사이트, 500빌드/월, 글로벌 CDN, 자동 HTTPS |
| **GitHub Actions** | CI/CD | Push 시 자동 빌드/배포 |
| **Sentry** | 에러 추적 | 무료 5K 이벤트/월 |
| **Resend** | 이메일 | 무료 100통/일 |

### AI/ML 서비스

| 기술 | 용도 | 비용 |
|------|------|------|
| **Google Cloud Speech-to-Text** | STT (1순위) | 월 60분 무료 + $0.016/분 |
| **OpenAI Whisper API** | STT (2순위 폴백) | $0.006/분 |
| **Naver CLOVA Speech** | STT (3순위, 정확도 최고) | ~900원/분 |
| **Whisper.cpp** | 온디바이스 오프라인 STT | 무료 |
| **Google Cloud Text-to-Speech** | 다국어 TTS (암송) | 무료 월 400만 글자 |

---

## STT 파이프라인 상세

```
[모바일/웹 녹음]
     │
     ▼
[오프라인 저장 (IndexedDB / AsyncStorage)]
     │ (온라인 연결 시)
     ▼
[Supabase Storage 업로드 (resumable upload)]
     │
     ▼
[Supabase DB Webhook 트리거]
     │
     ▼
[Supabase Edge Function]
     │
     ├──→ [Google Cloud STT API] ──→ 성공 시 결과 반환
     │         (1순위, $0.016/분)
     │
     ├──→ [폴백: Whisper API] ──→ Google 실패 시
     │         ($0.006/분)
     │
     └──→ [폴백: CLOVA Speech] ──→ 정확도 우선 모드 시
               (~900원/분)
     │
     ▼
[후처리 파이프라인]
     ├── 성경 용어 사전 교정
     ├── 구절 패턴 감지 (예: "요한복음 3장 16절")
     ├── 문단 분리
     └── 화자 분리 (가능한 경우)
     │
     ▼
[Supabase DB 저장]
     │
     ├──→ [Realtime 알림] (앱 내 알림)
     └──→ [FCM 푸시 알림] (모바일 푸시)
```

### STT 비용 비교

| 제공자 | 분당 비용 | 30분 설교 | 1,000교회 x 4회/월 |
|--------|----------|-----------|-------------------|
| **Google Cloud STT** | **$0.016 (~22원)** | **~650원** | **~2.6M원/월** |
| OpenAI Whisper | $0.006 (~8원) | ~250원 | ~1M원/월 |
| CLOVA Speech | ~15원/초 (~900원/분) | ~27,000원 | ~108M원/월 |

> Google Cloud STT + Whisper 조합이 가장 경제적. 무료 60분/월 + $300 크레딧도 초기에 활용 가능.

---

## 오프라인 아키텍처

### 오프라인 우선 설계 원칙

일요일 예배 시간은 네트워크 부하가 가장 높고 Wi-Fi가 불안정한 시간대이므로, 핵심 기능은 **100% 오프라인 동작**이 필수.

### 기술 구현

```
[앱/PWA]
    │
    ├── Service Worker (PWA)
    │   ├── 정적 자산 캐싱
    │   ├── API 응답 캐싱
    │   └── Background Sync
    │
    ├── IndexedDB (Dexie.js) / AsyncStorage (RN)
    │   ├── 오디오 녹음 데이터
    │   ├── 말씀노트 텍스트
    │   ├── 출석 체크 데이터
    │   └── 대기 큐 (업로드 예정)
    │
    └── Supabase JS Client
        ├── 오프라인 캐싱 활용
        └── Background Sync로 연결 복원 시 자동 업로드
```

**충돌 해결 전략**:
- 기본: Last-Write-Wins (타임스탬프 기반)
- 중요 데이터: UI 머지 프롬프트 (사용자 선택)

---

## Supabase 무료 티어 활용 전략

| 리소스 | 무료 한도 | MVP 예상 사용량 | 충분 여부 |
|--------|----------|----------------|-----------|
| DB | 500MB | ~100MB (500교회) | OK (초기) |
| Storage | 1GB | ~500MB (오디오) | OK (초기, 유료 전환 필요) |
| Edge Functions | 500K 호출/월 | ~100K | OK |
| Auth | 50,000 MAU | ~5,000 | OK |
| Realtime | 200 동시연결 | ~100 | OK (초기) |
| Bandwidth | 5GB/월 | ~3GB | OK (초기) |

**유료 전환 시점**: 등록 교회 500개 초과 또는 Storage 1GB 초과 시
- Supabase Pro: $25/월 (8GB DB, 100GB Storage)
- Cloudflare Pro: $20/월 (필요 시)

---

## 교회 홈페이지 빌더 아키텍처

```
[교회 가입 설문] → [AI 분석 (Edge Function)] → [템플릿 선택 + 데이터 매핑]
     │
     ▼
[Next.js SSG 빌드] → [Cloudflare Pages 배포]
     │
     ├── 서브도메인: 교회명.churchthrive.kr
     └── 커스텀 도메인: www.교회도메인.kr
     │
     ▼
[Supabase 공유 백엔드]
     ├── 앱과 동일 DB (교회 데이터)
     ├── 주보/공지 자동 연동
     ├── 설교 아카이브 연동
     └── 새가족 등록 → 교인관리 연동
```

---

## CI/CD 파이프라인

```
[GitHub Push]
     │
     ▼
[GitHub Actions]
     ├── Lint + Type Check
     ├── Unit Test (Vitest)
     ├── Build (Next.js)
     └── E2E Test (Playwright)
     │
     ▼
[Cloudflare Pages 자동 배포]
     ├── Preview (PR 별 프리뷰 URL)
     └── Production (main 브랜치)
```

---

## 보안 아키텍처

### 데이터 격리
- Supabase RLS (Row Level Security): 모든 테이블에 `church_id` 기반 정책 적용
- API 레벨에서도 church_id 검증
- Edge Function에서 JWT 토큰의 church_id claim 검증

### 암호화
- 전송: TLS 1.3 (Cloudflare 자동)
- 저장: Supabase Vault 또는 pgcrypto 확장
- 민감 데이터: 별도 암호화 컬럼

### 인증
- Supabase Auth + Kakao OAuth
- JWT 기반 세션 관리
- Refresh Token 로테이션
- 멀티팩터 인증 (MFA) 옵션

---

## 초기 인프라 비용 (MVP 6개월)

| 항목 | 월 비용 | 비고 |
|------|--------|------|
| Cloudflare Pages | **무료** | 무제한 사이트, 500빌드/월 |
| Supabase | **무료** | 500MB DB, 1GB Storage, 50K MAU |
| Google Cloud STT | **무료~50,000원** | 월 60분 무료 + $300 크레딧 |
| Whisper API (폴백) | ~20,000원 | 10% 폴백 트래픽 |
| 도메인 | ~15,000원 | churchthrive.kr |
| Sentry | **무료** | 5K 이벤트/월 |
| Resend (이메일) | **무료** | 100통/일 |
| FCM | **무료** | 무제한 |
| **월 합계** | **~85,000~135,000원** | 유료 API만 비용 발생 |
| **6개월 합계** | **~510,000~810,000원** | 인프라만 (인건비 별도) |
