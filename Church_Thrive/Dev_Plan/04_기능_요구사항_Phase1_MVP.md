# 04. 기능 요구사항 - Phase 1 MVP (Month 1-4)

---

## FR-0: 가입/인증/교회 격리 (P0 - 최우선)

### 가입 플로우

```
[사용자]                    [시스템]                    [교회 관리자]
   │                          │                           │
   ├─ 아이디+비밀번호 입력 ──→│                           │
   ├─ 소속 교회 검색/선택 ──→│                           │
   │                          ├─ 가입 요청 생성 ──────→  │
   │                          │                    승인/거절 판단
   │  ←── 대기 화면 표시 ────│                           │
   │                          │  ←─── 승인 응답 ─────── │
   │  ←── 가입 완료 알림 ────│                           │
   │     (앱 기능 접근 가능)   │                           │
```

1. 사용자가 아이디(이메일/전화번호) + 비밀번호 입력
2. 소속 교회 검색 → 선택 (교회명/주소 기반)
3. 가입 요청이 해당 교회의 **담당자(관리자) 또는 교역자에게 전송**
4. 담당자/교역자가 **승인** 후 가입 완료 → 교회 멤버로 등록
5. 승인 전까지 앱 기능 접근 불가 (대기 화면)

**추가 사항**:
- 교회 관리자가 일괄 승인/개별 승인 선택 가능
- 거절 시 사유 안내 메시지 발송
- Supabase Auth + Kakao OAuth 연동

### 교회별 완전 격리 (Multi-tenancy)

- 교회 A 회원은 교회 B 데이터에 **절대 접근 불가**
- Supabase RLS (Row Level Security)로 `church_id` 기반 완전 격리
- 검색/조회/API **모든 레벨**에서 교회 간 데이터 차단
- Edge Function에서도 church_id 검증 필수

### 교인 데이터 자기 관리

- 교인은 **본인 교적 데이터를 자유롭게 수정** 가능
  - 수정 가능: 이름, 연락처, 주소, 사진, 이메일 등
  - 수정 불가 (관리자만): 직분, 구역 배정, 역할, 직책
- 수정 이력 자동 기록 (audit trail)
- 관리자는 모든 교인 데이터 조회/수정 가능

### 교회 이적(전출/전입) 시스템

교인이 타교회로 이전 시:

1. 교인이 이적 요청 **또는** 교회 관리자가 이적 처리
2. **교인카드 이전**: 기존 교적 데이터를 새 교회로 이전 가능
3. **교인카드 백업**: 이전 전 기존 데이터를 개인 백업(다운로드) 가능
4. **이전/백업 모두 플랫폼 관리자(ChurchThrive) 승인 필요** (데이터 보호)
5. 승인 후 데이터 이동 실행 + 기존 교회에서 비활성화 처리

**주의사항**:
- 이전 이력은 양쪽 교회에 기록 보존
- 개인 데이터(말씀노트 등)는 교인 소유로 이전과 무관하게 유지
- 플랫폼 관리자 승인 없이 데이터 이동/백업 불가

---

## FR-1: 교인관리 (P0)

### 교적 관리

| 필드 | 타입 | 필수 | 비고 |
|------|------|------|------|
| 이름 | text | O | 초성 검색 지원 |
| 전화번호 | text | O | 카카오 연동 기반 |
| 이메일 | text | - | |
| 주소 | text | - | |
| 생년월일 | date | - | |
| 성별 | enum | - | |
| 세례일 | date | - | |
| 직분 | enum | - | 장로/권사/집사/안수집사/성도 등 |
| 교단 | text | - | |
| 구역/셀 | FK | - | 구역 테이블 참조 |
| 등록일 | date | O | 자동 기록 |
| 상태 | enum | O | 활성/비활성/이적 |
| 사진 | file | - | |

### 핵심 기능

- **가족 관계 연결**: 가족 구성원 간 관계 설정 (부부, 부모-자녀 등)
- **QR코드 새가족 등록**: QR 스캔 → 2분 내 기본 정보 입력 → 등록 완료
- **초성 검색**: ㅎㄱㄷ → 홍길동 (한국어 특화 검색)
- **심방 기록**: 심방일, 내용, 기도제목, 후속조치 기록
- **출석 기록**: 수동 체크 + QR 체크인 (예배별 출석 기록)
- **Excel 임포트**: 기존 교인 명부 일괄 업로드 (매핑 마법사)
- **CSV 익스포트**: 교인 데이터 내보내기
- **역할 기반 접근 제어 (RBAC)**: 역할에 따른 조회/수정 권한 분리

---

## FR-3: 말씀노트 (P0 - 게이트웨이 기능)

### 핵심 기능

1. **오디오 녹음**
   - 오프라인 지원 필수 (Service Worker + IndexedDB)
   - 녹음 중 앱 백그라운드 전환 시에도 녹음 유지
   - 최대 녹음 시간: 120분 (설교+특별집회 대응)
   - 온라인 연결 시 Supabase Storage 자동 업로드 (resumable)

2. **수동 텍스트 입력**
   - 리치 에디터 (볼드, 이탤릭, 밑줄, 하이라이트)
   - 설교 개요 템플릿: 서론/본론/결론/적용
   - 성경 구절 자동 링크 (구절 패턴 감지 → 성경 API 연결)
   - 하이라이트/주석 기능

3. **설교 아카이브**
   - 전문 검색 (제목, 본문, 날짜, 설교자)
   - 태그/카테고리 분류
   - 날짜순/설교자순 정렬

4. **공유**
   - 카카오톡 공유 (텍스트 + 링크)
   - 이미지 캡처 공유
   - PDF 내보내기

5. **오프라인→온라인 동기화**
   - 오프라인에서 녹음/작성 → 온라인 시 자동 업로드
   - Background Sync API 활용
   - 충돌 시 UI 머지 프롬프트

### 교역자 피드백 시스템

- 담당 교역자가 성도의 말씀노트를 **열람**하고 **피드백/코멘트 작성** 가능
- 성도에게 피드백 알림 발송 (푸시 + 앱내 알림)
- 교역자↔성도 간 대화형 코멘트 스레드

### 교역자 교체 권한 이관

매년 담당목사가 변경될 때:
1. 새 교역자가 성도에게 **접근 권한 요청** 전송
2. 성도가 **수락/거절** 선택
3. 수락 시 → 새 교역자에게 교적 + 말씀노트 열람 권한 부여
4. 기존 교역자의 접근 권한 자동 해제 (또는 교회 관리자가 수동 해제)

---

## FR-2: 교회 행정관리 - 기본 (P0)

### 공지/알림

- 교회 공지사항 작성 및 게시
- 푸시 알림 (FCM) + 카카오톡 알림톡 동시 발송
- 대상 그룹 지정 (전체, 특정 부서, 특정 구역 등)
- 공지 읽음 확인

### 교회 조직도 구성

- 교회 조직 구조 설정: 당회, 운영위원회, 각 부서, 특정 모임 등
- 계층형 조직 구조 지원
- 조직별 멤버 배정 및 역할 부여

### 직책(직분) 관리

- 교역자 또는 임원이 교회 직책 지정/변경
- 지원 직책: 장로, 권사, 집사, 안수집사, 청년 등 (커스텀 가능)
- 직책 변경 이력 자동 기록

### 역할별 권한 위임

대표목사/시스템관리자가 각 조직·모임·위원회에 개별 권한 부여:

| 권한 유형 | 설명 |
|-----------|------|
| **열람** | 해당 조직 문서/데이터 조회 가능 |
| **작성** | 문서/공지/보고서 작성 가능 |
| **결재** | 결재 라인에서 승인/반려 가능 |
| **관리** | 조직 설정 변경, 멤버 추가/삭제 가능 |

- 당회: 당회원만 접근 가능한 문서/결재
- 운영위원회: 운영위원만 접근 가능한 안건/회의록
- 특정 모임(선교회, 구역장모임 등): 모임별 독립 공간 + 권한

---

## FR-9: 교회 홈페이지 자동 빌드 (P0 - 가입 시 제공)

### 개요

교회 가입 시 설문 응답을 AI가 분석하여 **맞춤형 홈페이지를 자동 생성**한다.

### 가입 설문 (온보딩 플로우)

| 설문 항목 | 내용 | 필수 |
|-----------|------|------|
| 교회 기본정보 | 교회명, 교단, 담임목사, 연락처, 주소, 설립연도 | O |
| 교회 규모 | 교인 수, 예배 횟수, 부서 구성 | O |
| 교회 비전/미션 | 교회 소개 텍스트, 핵심 가치 | O |
| 예배 안내 | 예배 시간, 장소, 주차 안내 | O |
| 사진/로고 | 교회 외관, 내부, 목사님 사진, 로고 업로드 | - |
| 디자인 선호 | 색상 테마, 레이아웃 스타일 선택 | - |

### AI 분석 → 자동 홈페이지 생성

- 설문 응답을 기반으로 교회 맞춤 홈페이지 자동 생성
- **Cloudflare Pages**로 무료 호스팅
- 교회별 서브도메인: `교회명.churchthrive.kr`
- 커스텀 도메인 연결 지원 (교회 자체 도메인)

### 홈페이지 기본 구성

1. 교회 소개 (비전/미션/역사)
2. 예배 안내 (시간/장소/지도)
3. 담임목사 인사말
4. 주보/공지사항 (앱과 자동 연동)
5. 설교 아카이브 (앱의 설교 데이터 연동)
6. 새가족 등록 (QR코드 + 온라인 폼 → 앱 교인관리 연동)
7. 오시는 길 (카카오맵/네이버맵 연동)
8. 포토 갤러리
9. 연락처/문의

### 앱 연동

- 홈페이지 ↔ ChurchThrive 앱 **완전 연동**
- 홈페이지에서 바로 앱 기능 접근 (말씀노트, 훈련신청, 헌금 등)
- 주보/공지를 앱에서 작성하면 홈페이지에 **자동 게시**
- 설교 오디오/텍스트를 앱에서 업로드하면 홈페이지에 **자동 게시**
- 새가족 온라인 등록 → 앱 교인관리 **자동 반영**

### 기술 구현

- Cloudflare Pages로 정적 사이트 생성 (Next.js SSG)
- Supabase를 공유 백엔드로 사용 (앱과 동일 DB)
- 교회별 테마/레이아웃 커스터마이징 (드래그앤드롭 에디터)
- 비용: **완전 무료** (Cloudflare Pages 무료 + Supabase 공유)

---

## FR-5.4: 구역/셀 관리 (P0)

- 구역 생성 및 관리
- 구역 리더 배정
- 구역별 출석 기록
- 구역 활동 보고서 (자동 생성)
- 구역 변경 이력 관리

---

## MVP 수용 기준

| # | 기준 | 검증 방법 |
|---|------|-----------|
| 1 | 사무간사가 Excel에서 200명 임포트 후 검색/편집 가능 | 실사용 테스트 |
| 2 | 교인이 30분 설교 녹음 + 노트 작성 (3탭 이내 시작) | UX 테스트 |
| 3 | 목사가 대시보드에서 출석/심방/일정 확인 가능 | 실사용 테스트 |
| 4 | 방문자가 QR 스캔 → 2분 내 등록 완료 | 타이머 측정 |
| 5 | Samsung Galaxy A시리즈에서 2초 내 로딩 | 성능 테스트 |
| 6 | Kakao Login 정상 동작 | 통합 테스트 |
| 7 | 교회 A 데이터가 교회 B에 노출 불가 | 보안 테스트 |
| 8 | Pretendard 폰트, 최소 16px, WCAG 2.1 AA 통과 | 접근성 감사 |
