# 07. 데이터베이스 설계

## 개요

- **DBMS**: Supabase PostgreSQL (RLS 멀티테넌시)
- **격리 전략**: Row Level Security (RLS)로 `church_id` 기반 교회 데이터 완전 격리
- **암호화**: Supabase Vault 또는 pgcrypto 확장으로 민감 데이터 암호화

---

## 핵심 엔티티 관계도 (ERD)

```
Church ──── Member ──── Family
  │           │
  ├── Sermon ── SermonNote (말씀노트) ── NoteFeedback (교역자 피드백)
  │
  ├── Organization (조직) ── OrgRole (조직 권한)
  │   ├── 당회, 운영위원회, 각 부서, 특정 모임 등
  │   └── Permission (열람/작성/결재/관리 4단계)
  │
  ├── ApprovalWorkflow (전자결재)
  │   ├── Report (보고서) ── ApprovalLine (결재라인)
  │   └── ApprovalStep (기안→검토→승인) ── DeptNotification (부서 참조)
  │
  ├── Training ── TrainingEnrollment ── TrainingSession
  │                                  ── TrainingAnnouncement
  ├── Ministry ── MinistryMember
  ├── Attendance
  ├── FinanceTransaction
  ├── Event ── EventRSVP
  ├── Meeting ── MeetingActionItem
  ├── Announcement
  ├── CellGroup ── CellGroupMember
  ├── LVIAssessment
  │
  ├── BibleMemorization (말씀 암송, 다국어: 한/영/일/중)
  │   └── MemorizationProgress
  ├── BibleReadingPlan (말씀 통독)
  │   ├── ReadingProgress
  │   └── CopyingProgress (필사 진행)
  │
  └── PastorAssignment (교역자 배정) ── AccessRequest (권한 요청/수락)
```

---

## 핵심 테이블 정의

### churches (교회)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | 교회 고유 ID |
| name | text | 교회명 |
| denomination | text | 교단 |
| address | text | 주소 |
| phone | text | 연락처 |
| senior_pastor | text | 담임목사명 |
| founded_year | integer | 설립연도 |
| member_count | integer | 교인 수 |
| subscription_tier | enum | 구독 티어 (free/basic/standard/premium) |
| subdomain | text | 홈페이지 서브도메인 |
| custom_domain | text | 커스텀 도메인 |
| created_at | timestamptz | 생성일시 |
| updated_at | timestamptz | 수정일시 |

### members (교인)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | 교인 고유 ID |
| church_id | uuid (FK) | 소속 교회 |
| user_id | uuid (FK) | Supabase Auth 사용자 ID |
| name | text | 이름 |
| phone | text | 전화번호 |
| email | text | 이메일 |
| address | text | 주소 |
| birth_date | date | 생년월일 |
| gender | enum | 성별 |
| baptism_date | date | 세례일 |
| position | enum | 직분 (장로/권사/집사/안수집사/성도) |
| cell_group_id | uuid (FK) | 소속 구역/셀 |
| role | enum | 시스템 역할 (admin/pastor/staff/leader/member) |
| status | enum | 상태 (pending/active/inactive/transferred) |
| photo_url | text | 프로필 사진 URL |
| joined_at | date | 등록일 |
| created_at | timestamptz | 생성일시 |
| updated_at | timestamptz | 수정일시 |

### families (가족 관계)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| church_id | uuid (FK) | 소속 교회 |
| family_name | text | 가족명 |
| created_at | timestamptz | |

### family_members (가족 구성원)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| family_id | uuid (FK) | 가족 |
| member_id | uuid (FK) | 교인 |
| relationship | enum | 관계 (가장/배우자/자녀/부모 등) |

### sermons (설교)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| church_id | uuid (FK) | 소속 교회 |
| preacher_id | uuid (FK) | 설교자 |
| title | text | 제목 |
| bible_verses | text[] | 성경 구절 |
| sermon_date | date | 설교 날짜 |
| service_type | enum | 예배 유형 (주일/수요/금요 등) |
| audio_url | text | 오디오 파일 URL |
| transcript | text | STT 변환 텍스트 |
| stt_status | enum | STT 상태 (pending/processing/completed/failed) |
| created_at | timestamptz | |

### sermon_notes (말씀노트)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| church_id | uuid (FK) | 소속 교회 |
| member_id | uuid (FK) | 작성자 |
| sermon_id | uuid (FK) | 연결 설교 |
| content | jsonb | 노트 내용 (리치 텍스트) |
| audio_url | text | 개인 녹음 URL |
| highlights | jsonb | 하이라이트/주석 |
| is_shared | boolean | 공유 여부 |
| created_at | timestamptz | |
| updated_at | timestamptz | |

### note_feedbacks (교역자 피드백)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| sermon_note_id | uuid (FK) | 대상 말씀노트 |
| pastor_id | uuid (FK) | 피드백 작성 교역자 |
| content | text | 피드백 내용 |
| created_at | timestamptz | |

### pastor_assignments (교역자 배정)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| church_id | uuid (FK) | 소속 교회 |
| pastor_id | uuid (FK) | 교역자 |
| member_id | uuid (FK) | 담당 성도 |
| status | enum | 상태 (pending/active/expired) |
| accepted_at | timestamptz | 성도 수락 일시 |
| expires_at | timestamptz | 만료일 |
| created_at | timestamptz | |

### access_requests (접근 권한 요청)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| pastor_assignment_id | uuid (FK) | 교역자 배정 |
| requested_by | uuid (FK) | 요청자 (새 교역자) |
| status | enum | 상태 (pending/accepted/rejected) |
| requested_at | timestamptz | |
| responded_at | timestamptz | |

### organizations (조직)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| church_id | uuid (FK) | 소속 교회 |
| name | text | 조직명 (당회, 운영위, 청년부 등) |
| type | enum | 조직 유형 (committee/department/group/team) |
| parent_id | uuid (FK) | 상위 조직 (계층 구조) |
| description | text | 설명 |
| created_at | timestamptz | |

### org_roles (조직 역할/권한)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| organization_id | uuid (FK) | 조직 |
| member_id | uuid (FK) | 교인 |
| role | enum | 역할 (head/member/secretary) |
| permissions | text[] | 권한 목록 (read/write/approve/admin) |
| delegated_by | uuid (FK) | 권한 위임자 |
| created_at | timestamptz | |

### approval_workflows (전자결재)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| church_id | uuid (FK) | |
| title | text | 결재 제목 |
| report_type | enum | 보고서 유형 |
| content | jsonb | 보고서 내용 |
| author_id | uuid (FK) | 기안자 |
| status | enum | 상태 (draft/pending/approved/rejected/hold) |
| cc_departments | uuid[] | 참조 부서 목록 |
| created_at | timestamptz | |

### approval_steps (결재 단계)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| workflow_id | uuid (FK) | 결재 워크플로우 |
| step_order | integer | 단계 순서 |
| approver_id | uuid (FK) | 결재자 |
| status | enum | 상태 (pending/approved/rejected/hold) |
| comment | text | 결재 의견 |
| acted_at | timestamptz | 처리 일시 |

### trainings (훈련)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| church_id | uuid (FK) | |
| title | text | 훈련명 |
| description | text | 설명 |
| start_date | date | 시작일 |
| end_date | date | 종료일 |
| max_participants | integer | 정원 |
| requirements | jsonb | 자격 요건 |
| completion_criteria | jsonb | 수료 기준 |
| status | enum | 상태 (upcoming/active/completed) |
| created_at | timestamptz | |

### training_enrollments (훈련 신청)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| training_id | uuid (FK) | 훈련 |
| member_id | uuid (FK) | 교인 |
| status | enum | 상태 (applied/enrolled/waitlisted/completed/dropped) |
| completion_rate | float | 이수율 |
| certificate_url | text | 수료증 URL |
| enrolled_at | timestamptz | |

### bible_memorizations (말씀 암송)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| church_id | uuid (FK) | |
| verse_reference | text | 구절 참조 (예: "요 3:16") |
| verse_text_ko | text | 한국어 본문 |
| verse_text_en | text | 영어 본문 |
| verse_text_ja | text | 일본어 본문 |
| verse_text_zh | text | 중국어 본문 |
| assigned_by | uuid (FK) | 지정자 (교회/개인) |
| is_church_assigned | boolean | 교회 공동 암송 여부 |
| created_at | timestamptz | |

### memorization_progress (암송 진행)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| memorization_id | uuid (FK) | 암송 구절 |
| member_id | uuid (FK) | 교인 |
| language | enum | 암송 언어 |
| stage | integer | 현재 단계 (1-4) |
| completed | boolean | 완료 여부 |
| completed_at | timestamptz | |

### bible_reading_plans (말씀 통독)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| church_id | uuid (FK) | |
| plan_type | enum | 플랜 유형 (1year/6month/3month) |
| title | text | 플랜명 |
| is_community | boolean | 공동체 통독 여부 |
| start_date | date | 시작일 |
| created_at | timestamptz | |

### reading_progress (통독 진행)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| plan_id | uuid (FK) | 통독 플랜 |
| member_id | uuid (FK) | 교인 |
| book | text | 성경 권 |
| chapter | integer | 장 |
| completed | boolean | 완료 여부 |
| read_at | timestamptz | |

### copying_progress (필사 진행)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| member_id | uuid (FK) | 교인 |
| verse_reference | text | 구절 참조 |
| copied_text | text | 필사한 텍스트 |
| mode | enum | 모드 (with_reference/from_memory) |
| completed_at | timestamptz | |

### attendances (출석)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| church_id | uuid (FK) | |
| member_id | uuid (FK) | 교인 |
| event_type | enum | 예배/모임/훈련 등 |
| event_id | uuid | 관련 이벤트 ID |
| checked_in_at | timestamptz | 체크인 시각 |
| check_method | enum | 방법 (manual/qr) |

### cell_groups (구역/셀)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| church_id | uuid (FK) | |
| name | text | 구역명 |
| leader_id | uuid (FK) | 구역장 |
| created_at | timestamptz | |

### announcements (공지사항)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid (PK) | |
| church_id | uuid (FK) | |
| title | text | 제목 |
| content | text | 내용 |
| author_id | uuid (FK) | 작성자 |
| target_groups | uuid[] | 대상 그룹 |
| is_published | boolean | 게시 여부 |
| published_at | timestamptz | |
| created_at | timestamptz | |

---

## RLS (Row Level Security) 정책

### 기본 정책 패턴

모든 테이블에 적용되는 기본 RLS 패턴:

```sql
-- 교회 데이터 격리: 자신의 교회 데이터만 접근 가능
CREATE POLICY "church_isolation" ON [table_name]
  FOR ALL
  USING (
    church_id = (
      SELECT church_id FROM members
      WHERE user_id = auth.uid()
    )
  );
```

### 역할별 추가 정책

```sql
-- 관리자: 교회 내 모든 데이터 접근
CREATE POLICY "admin_full_access" ON members
  FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM members m
      WHERE m.user_id = auth.uid()
      AND m.church_id = members.church_id
      AND m.role IN ('admin', 'pastor')
    )
  );

-- 교인: 본인 데이터만 수정 가능
CREATE POLICY "member_self_update" ON members
  FOR UPDATE
  USING (user_id = auth.uid())
  WITH CHECK (
    -- 직분, 구역 등 관리 필드는 변경 불가
    position IS NOT DISTINCT FROM OLD.position
    AND cell_group_id IS NOT DISTINCT FROM OLD.cell_group_id
    AND role IS NOT DISTINCT FROM OLD.role
  );

-- 교역자: 담당 성도의 말씀노트 열람 (승인된 경우만)
CREATE POLICY "pastor_note_access" ON sermon_notes
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM pastor_assignments pa
      WHERE pa.pastor_id = (
        SELECT id FROM members WHERE user_id = auth.uid()
      )
      AND pa.member_id = sermon_notes.member_id
      AND pa.status = 'active'
    )
  );
```

---

## 인덱스 전략

```sql
-- 교회별 조회 최적화
CREATE INDEX idx_members_church_id ON members(church_id);
CREATE INDEX idx_sermon_notes_church_member ON sermon_notes(church_id, member_id);
CREATE INDEX idx_attendances_church_date ON attendances(church_id, checked_in_at);

-- 초성 검색 최적화
CREATE INDEX idx_members_name_trgm ON members USING gin(name gin_trgm_ops);

-- 설교 전문 검색
CREATE INDEX idx_sermons_fts ON sermons USING gin(to_tsvector('korean', title || ' ' || COALESCE(transcript, '')));
```

---

## 데이터 마이그레이션

### Excel 임포트 매핑

| Excel 컬럼 | DB 컬럼 | 변환 |
|-----------|---------|------|
| 이름 | name | 직접 매핑 |
| 전화번호 | phone | 정규화 (010-xxxx-xxxx) |
| 직분 | position | enum 매핑 |
| 세례일 | baptism_date | 날짜 파싱 |
| 구역 | cell_group_id | 구역명 → ID 매핑 |
| 주소 | address | 직접 매핑 |

### 이적 데이터 이동

```
[교인 이적 요청] → [플랫폼 관리자 승인]
     │
     ▼
[데이터 복제]
  ├── members 레코드 → 새 교회 church_id로 복제
  ├── sermon_notes → 교인 소유 (이동하지 않음, 교인 계정에 유지)
  ├── training_enrollments → 이력으로 보존
  └── 기존 교회 레코드 → status = 'transferred'
```
